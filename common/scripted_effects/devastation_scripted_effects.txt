devastation_test = { 
	ETH = {
		set_province_controller = 9772
		set_province_controller = 11773
	}
	
	114 = {
		set_variable = { state_devastation_value = 100 }
	}
	##add_ideas = devastation_test_idea
}

devastation_test2 = {
	851 = {
		#if = {
		#	limit = { is_coastal = yes }
			
			every_state = {
				limit = { is_coastal = yes NOT = { state = PREV } distance_to = { value < 5000 target = PREV } NOT = { is_capital = yes } }
				transfer_state_to = CHL
			}
		#}
	}
}

d_damage_infrastructure = { 
	damage_building = {
		type = infrastructure
		damage = 1
	}
}

d_add_resistance = { 
	add_resistance = args^0
}

d_set_controller = { 
	#838 = {
	#	set_state_controller = ITA
	#}
}

debug_every_states_neighbor_devastation = { 
	every_state = {
		limit = { 
			controller = {
				set_temp_variable = { global.state_controler = THIS.id }
			}
			any_neighbor_state = { 
				controller = { 
					NOT = { tag = var:global.state_controler } 
				} 
			}
		}
		set_variable = { state_devastation_value = 100 }
		devastation_state_random_value = yes
		devastation_state_calc_modifiers = yes
	}
	every_country = {
		hidden_effect = {
			devastation_country_calc_value = yes
			#devastation_country_calc_modifiers = yes
		}
	}
}

debug_every_states_0_devastation = { 
	every_state = {
		set_variable = { state_devastation_value = 0 }
		devastation_state_calc_modifiers = yes
	}
	every_country = {
		hidden_effect = {
			devastation_country_calc_value = yes
			#devastation_country_calc_modifiers = yes
		}
	}
}

debug_every_states_100_devastation = { 
	every_state = {
		set_variable = { state_devastation_value = 100 }
		devastation_state_calc_modifiers = yes
	}
	every_country = {
		hidden_effect = {
			devastation_country_calc_value = yes
			#devastation_country_calc_modifiers = yes
		}
	}
}

debug_every_states_random_devastation = { 
	every_state = {
		set_variable = { state_devastation_value = 0 }
		devastation_state_random_value = yes
		devastation_state_calc_modifiers = yes
	}
	every_country = {
		hidden_effect = {
			devastation_country_calc_value = yes
			#devastation_country_calc_modifiers = yes
		}
	}
}

devastation_state_change_value = { 
	add_to_variable = { state_devastation_value = temp }
	custom_effect_tooltip = devastation_state_change_value_tt
}

devastation_state_random_value = { 
	set_variable_to_random = { var = state_devastation_value min = 1 max = 100 integer = yes }
}

devastation_state_calc_modifiers = { 
	clear_array = state_devastation_modifier
	clamp_variable = { var = state_devastation_value min = 0 max = 100 }
	
			
	# local_supplies -0.50
	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_local_supplies }
	divide_temp_variable = { temp = temp_100 }
	add_to_array = { state_devastation_modifier = temp }
	
	# local_factories -0.35
	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_local_factories }
	divide_temp_variable = { temp = temp_100 }
	add_to_array = { state_devastation_modifier = temp }
	
	# local_building_slots -20
	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_local_building_slots }
	divide_temp_variable = { temp = temp_100 }
	round_temp_variable = temp
	add_to_array = { state_devastation_modifier = temp }
	
	# state_resources_factor -0.9
	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_state_resources_factor }
	divide_temp_variable = { temp = temp_100 }
	add_to_array = { state_devastation_modifier = temp }
	
	# state_production_speed_buildings_factor -0.75
	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_state_production_speed_buildings_factor }
	divide_temp_variable = { temp = temp_100 }
	add_to_array = { state_devastation_modifier = temp }
	
	# USED BY 'state_repair_speed_arms_factory_factor' AND 'state_repair_speed_industrial_complex_factor' AS WELL
	# state_repair_speed_infrastructure_factor -0.5
	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_state_repair_speed_buildings_factor }
	divide_temp_variable = { temp = temp_100 }
	add_to_array = { state_devastation_modifier = temp }

	set_temp_variable = { temp = state_devastation_value }
	set_temp_variable = { temp_100 = 100 }
	divide_temp_variable = { temp_100 = global.devastation_army_speed_factor }
	divide_temp_variable = { temp = temp_100 }
	add_to_array = { state_devastation_modifier = temp }
	
	force_update_dynamic_modifier = yes
}

devastation_country_calc_value = { 
	clear_variable = country_devastation_value
	set_temp_variable = { devastation_country_score = 0 } 
	set_temp_variable = { devastation_country_population = 0 } 
	
	every_owned_state = {
		set_temp_variable = { devastation_state_score = 0 }
		
		set_temp_variable = { devastation_percentage = state_devastation_value }
		divide_temp_variable = { devastation_percentage = 100 }
		##log = "[THIS.GetName]: Devastation Percentage - [?devastation_percentage|%]"
		
		devastation_get_state_type_multiplier = yes
		add_to_temp_variable = { devastation_state_type_multiplier = 5 }
		##log = "[THIS.GetName]: Devastation State Multiplier - [?devastation_state_type_multiplier]"
		
		set_temp_variable = { devastation_state_score = state_population_k }
		divide_temp_variable = { devastation_state_score = 1000 }
		##log = "[THIS.GetName]: Devastation State Population - [?state_population_k]"
		
		multiply_temp_variable = { devastation_state_score = devastation_percentage }
		multiply_temp_variable = { devastation_state_score = devastation_state_type_multiplier }
		
		##log = "[THIS.GetName]: Devastation State Score - [?devastation_state_score]"
		add_to_temp_variable = { PREV.devastation_country_score = devastation_state_score }
		
	}
	set_temp_variable = { devastation_max_population = max_manpower_k }
	divide_temp_variable = { devastation_max_population = 1000 }
	divide_temp_variable = { devastation_country_score = devastation_max_population }
	
	set_variable = { country_devastation_value = devastation_country_score }
	##log = "[THIS.GetName]: [?country_devastation_value] - [?max_manpower_k] K"
}

devastation_country_calc_modifiers = { 
	if = {
		limit = { 
			NOT = {
				has_dynamic_modifier = {
					modifier = country_devastation_modifier
				}
			}
		}
		add_dynamic_modifier = {
			modifier = country_devastation_modifier
		}
	}
	#set_variable = { country_devastation_value = 100 }
	clear_array = country_devastation_modifier
	
	# stability_factor
	set_temp_variable = { temp = country_devastation_value }
	multiply_temp_variable = { temp = global.country_devastation_stability_factor }
	divide_temp_variable = { temp = 100 }
	add_to_array = { country_devastation_modifier = temp }
	
	# war_support_factor
	set_temp_variable = { temp = country_devastation_value }
	multiply_temp_variable = { temp = global.country_devastation_war_support_factor }
	divide_temp_variable = { temp = 100 }
	add_to_array = { country_devastation_modifier = temp }
	
	# production_speed_buildings_factor
	set_temp_variable = { temp = country_devastation_value }
	multiply_temp_variable = { temp = global.country_devastation_production_speed_buildings_factor }
	divide_temp_variable = { temp = 100 }
	add_to_array = { country_devastation_modifier = temp }
	
	force_update_dynamic_modifier = yes
}

weekly_devastation_update = {
	every_state = {
		
		if = {
			limit = {
				has_state_flag = {
					flag = recently_attempted_to_migrated_factory
					days > 120
				}
			}
			clr_state_flag = recently_attempted_to_migrated_factory
		}
	}
}

daily_devastation_update = {
	every_country = {
		devastation_country_calc_value = yes
		calc_casualties = yes
	}
	
	every_state = {
		devastation_state_calc_value = yes
	}
}

get_devastation_gain_threshold = {
	set_temp_variable = { temp_threshold = 1 }
	#log = "Threshold Before Subtraction: [?temp_threshold]"
	if = {
		limit = { check_variable = { state_devastation_value > 79.99 } }
		subtract_from_temp_variable = { temp_threshold = global.devastation_base_gain_threshold_4 }
		#log = "Threshold 1: [?global.devastation_base_gain_threshold_4]"
	}
	else_if = {
		limit = { check_variable = { state_devastation_value > 49.99 } }
		subtract_from_temp_variable = { temp_threshold = global.devastation_base_gain_threshold_3 }
		#log = "Threshold 2: [?global.devastation_base_gain_threshold_3]"
	}
	else_if = {
		limit = { check_variable = { state_devastation_value > 19.99 } }
		subtract_from_temp_variable = { temp_threshold = global.devastation_base_gain_threshold_2 }
		#log = "Threshold 3: [?global.devastation_base_gain_threshold_2]"
	}
	else = {
		subtract_from_temp_variable = { temp_threshold = global.devastation_base_gain_threshold_1 }
		#log = "Threshold 4: [?global.devastation_base_gain_threshold_1]"
	}
	clamp_temp_variable = { var = temp_threshold min = 0 max = 1 }
	
	#log = "Final Threshold after Subtraction: [?temp_threshold]"
}

generate_random_casualties = {
	if = {
		limit = { check_variable = { state_population_k > 1 } }
		set_temp_variable_to_random = { var = temp_casualty min = temp_min max = temp_max }
		
		set_temp_variable = { global.civ_casualty_gain = temp_casualty }
		owner = {
			set_temp_variable = { temp = global.civ_casualty_gain }
			#log = "[THIS.GetTag]: Civ Casualties Gain - [?global.civ_casualty_gain]"
			add_civ_casualties_to_owner = yes
		}
		calc_pop_change = yes
		
		multiply_temp_variable = { temp_casualty = -1 }

		
		controller = {
			set_temp_variable = { manpower = manpower_per_military_factory }
			set_temp_variable = { mils = num_of_military_factories }
		}

		add_manpower = temp_casualty
		
		controller = {
			set_temp_variable = { manpower_two = manpower_per_military_factory }
			set_temp_variable = { mils = num_of_military_factories }
			subtract_from_temp_variable = { manpower_two = manpower }
			multiply_temp_variable = { manpower_two = num_of_military_factories }
			if = {
				limit = {
					check_variable = { manpower_two > 0 }
				}
				multiply_temp_variable = { manpower_two = -1 }
				add_manpower = manpower_two
			}
		}

		multiply_temp_variable = { temp_casualty = -1 }
		set_temp_variable = { devastation_state_casualties_k = temp_casualty }
		divide_temp_variable = { devastation_state_casualties_k = 1000 }
		add_to_variable = { devastation_state_casualties = devastation_state_casualties_k }
	}
}

add_civ_casualties_to_owner = {
	if = {
		limit = { check_variable = { temp < 0 } }
		multiply_temp_variable = { temp = -1 }
	}
	add_to_temp_variable = { civ_casualties = temp }
	divide_temp_variable = { civ_casualties = 1000 }
	
	add_to_variable = { civ_casualties_k = civ_casualties }
	
	calc_casualties = yes
}

calc_casualties = {
	if = {
		limit = { check_variable = { casualties_k > 999.999 } }
		set_variable = { casualties_m = casualties_k }
		divide_variable = { casualties_m = 1000 }
	}
	else = {
		clear_variable = casualties_m
	}
	if = {
		limit = { check_variable = { civ_casualties_k > 999.999 } }
		set_variable = { civ_casualties_m = civ_casualties_k }
		divide_variable = { civ_casualties_m = 1000 }
	}
	else = {
		clear_variable = civ_casualties_m
	}
	
	set_variable = { total_casualties_k = casualties_k }
	add_to_variable = { total_casualties_k = civ_casualties_k }
	if = {
		limit = { check_variable = { total_casualties_k > 999.999 } }
		set_variable = { total_casualties_m = total_casualties_k }
		divide_variable = { total_casualties_m = 1000 }
	}
	else = {
		clear_variable = total_casualties_m
	}
}

calc_pop_change = {
	#round_variable = devastation_state_casualties
	
	#if = {
	#	limit = {
	#		controller = { has_war = yes }
	#	}

		subtract_from_temp_variable = { temp_pop_change = devastation_state_casualties }
		
		#set_temp_variable = { old_pop_change = devastation_state_pop_change }
		#if = {
		#	limit = { NOT = { check_variable = { old_pop_change = temp_pop_change } } }
			set_variable = { devastation_state_pop_change = temp_pop_change }
		#}
	#}
}

devastation_get_state_type_multiplier = {
	if = {
		limit = { is_wasteland_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 0 }
	}
	else_if = {
		limit = { is_pastoral_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 1 }
	}
	else_if = {
		limit = { is_rural_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 2 }
	}
	else_if = {
		limit = { is_town_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 4 }
	}
	else_if = {
		limit = { is_large_town_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 5 }
	}
	else_if = {
		limit = { is_city_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 6 }
	}
	else_if = {
		limit = { is_large_city_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 8 }
	}
	else_if = {
		limit = { is_metropolis_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 10 }
	}
	else_if = {
		limit = { is_megalopolis_state = yes }
		set_temp_variable = { devastation_state_type_multiplier = 12 }
	}
}

devastation_state_calc_value = {
	calc_pop_change = yes
	set_variable = { state_devastation_previous_value = state_devastation_value }
	#log = "[THIS.GetName] State Devastation Previous Value: [?state_devastation_previous_value]"
	
	set_temp_variable = { base_gain = 0 }
	#log = "[THIS.GetName] Base Gain: [?base_gain]"
	
	#if = {
	#	limit = {
	#		# if state is fully occupied, and has resistance
	#		state_is_fully_controlled_owner = yes
	#	}
		
		if = {
			limit = {
				state_is_fully_controlled_owner = yes
				#has_resistance = yes
				check_variable = { resistance > 0.499 }
				check_variable = { state_devastation_value < 35 }
			}
		
			# then for every point of resistane, add 0.003 to base gain
			set_temp_variable = { base_gain_resistance = resistance }
			round_temp_variable = base_gain_resistance
			#log = "[THIS.GetName] Base Gain Resistance: [?base_gain_resistance]"
			
			#divide_temp_variable = { base_gain_resistance = 333.333 }
			multiply_temp_variable = { base_gain_resistance = global.devastation_base_gain_resistance }
			divide_temp_variable = { base_gain_resistance = 2 }			### Added this, otherwise resistance is too strong and cannot be fought devastation-wise
			set_variable = { state_devastation_base_gain_resistance = base_gain_resistance }
			#log = "[THIS.GetName] Base Gain Resistance after multiplier: [?base_gain_resistance]"
			
			add_to_temp_variable = { base_gain = base_gain_resistance }
			#log = "[THIS.GetName] Base Gain Resistance -> Base Gain: [?base_gain]"
		}
	#}
	#else = {
		if = {
			limit = {
				controller_has_war_with_owner = yes
				state_is_fully_controlled_owner = no
			}
			
			if = {
				limit = { check_variable = { state_devastation_value < 75 } }
				add_to_temp_variable = { base_gain = global.devastation_base_gain_controller_at_war_with_owner }
				#log = "[THIS.GetName] Global|Controller at war with owner: [?global.devastation_base_gain_controller_at_war_with_owner] -> Base Gain: [?base_gain]"
			}
			else = {
				add_to_temp_variable = { base_gain = 0.05 }
				#log = "[THIS.GetName] Base Gain: [?base_gain]"
			}
		}
		
		if = {
			limit = {
				state_isnt_fully_controlled_owner = yes
				check_variable = { state_devastation_value < 85 }
			}
			add_to_temp_variable = { base_gain = global.devastation_base_gain_partial_occupation }
			#log = "[THIS.GetName] Global|Partial Occupation: [?global.devastation_base_gain_partial_occupation] -> Base Gain: [?base_gain]"
		}
		
		if = {
			limit = {
				neighbor_state_has_direct_war = yes
			}
			add_to_temp_variable = { base_gain = global.devastation_base_gain_neighbor_state_is_enemy }
			#log = "[THIS.GetName] Global|Neighbor state is enemy: [?global.devastation_base_gain_neighbor_state_is_enemy] -> Base Gain: [?base_gain]"
		}
	#}
	
	if = {
		limit = {
			has_recently_experienced_strat_bombing = yes
		}
		add_to_temp_variable = { base_gain = global.devastation_base_gain_experienced_bombing }
		#log = "[THIS.GetName] Global|Bombing: [?global.devastation_base_gain_controller_at_war_with_owner] -> Base Gain: [?base_gain]"
		
		set_temp_variable = { temp_min = 100 }		# Original 50
		set_temp_variable = { temp_max = 402 }		# Original 201
		generate_random_casualties = yes
	}
	
	
	set_temp_variable = { base_loss = 0 }
	#log = "[THIS.GetName] Base Loss: [?base_loss]"
	
	if = {
		limit = {
			controller_has_war_with_owner = no
		}
		add_to_temp_variable = { base_loss = global.devastation_base_gain_controller_at_peace_with_owner }
		#log = "[THIS.GetName] Global|Controller at peace with owner: [?global.devastation_base_gain_controller_at_war_with_owner] -> Base Loss: [?base_loss]"
	}
	if = {
		limit = {
			controller_at_peace = yes
		}
		add_to_temp_variable = { base_loss = global.devastation_base_gain_controller_at_peace }
		#log = "[THIS.GetName] Global|Controller at peace: [?global.devastation_base_gain_controller_at_war_with_owner] -> Base Loss: [?base_loss]"
	}
	
	controller = {
		if = {
			limit = { NOT = { check_variable = { modifier@state_devastation_reduction = 0 } } }
			
			PREV = {
				add_to_temp_variable = { base_loss = PREV.modifier@state_devastation_reduction }
				#log = "[THIS.GetName] Modifier|State Devastation Reduction: [?PREV.modifier@state_devastation_reduction] -> Base Loss: [?base_loss]"
			}
		}
		if = {
			limit = { NOT = { check_variable = { modifier@state_devastation_reduction_factor = 0 } } }
			
			PREV = {
				set_temp_variable = { temp_a = base_loss }
				set_temp_variable = { temp_b = PREV.modifier@state_devastation_reduction_factor }
				multiply_temp_variable = { temp_b = -1 }
				multiply_temp_variable = { temp_a = temp_b }
				add_to_temp_variable = { base_loss = temp_a }
				#log = "[THIS.GetName] Modifier|State Devastation Reduction Factor: [?PREV.modifier@state_devastation_reduction] -> Base Loss: [?base_loss]"
			}
		}
	}
	
	#log = "[THIS.GetName] Base Gain Before Threshold: [?base_gain]"
	get_devastation_gain_threshold = yes
	multiply_temp_variable = { base_gain = temp_threshold }
	#log = "[THIS.GetName] Base Gain After Threshold: [?base_gain]"
	set_temp_variable = { temp_threshold_loss = 1 }					# Addition, saturation factor helps reducing devastation now
	subtract_from_temp_variable = { temp_threshold_loss = temp_threshold }					# Addition
	add_to_temp_variable = { temp_threshold_loss = 1 }					# Addition
	multiply_temp_variable = { base_loss = temp_threshold_loss }			# Addition
	
	add_to_variable = { state_devastation_value = base_gain }
	add_to_variable = { state_devastation_value = base_loss }
	
	set_variable = { state_devastation_value_change = base_gain }
	add_to_variable = { state_devastation_value_change = base_loss }
	
	devastation_state_calc_modifiers = yes
	
	if = {
		limit = { state_isnt_fully_controlled_owner = yes }
		
		set_temp_variable = { global.state_original_controller = THIS.owner }
		set_temp_variable = { temp_min = 5 }
		set_temp_variable = { temp_max = 10 }
		generate_random_casualties = yes
	}
	
	calc_pop_change = yes
	
}


	
casualty_sort_add_dummy = {
	add_to_array = { global.countries_casualty = 0 }	# dummy
}
casualty_sort_remove_dummy = {
	remove_from_array = { global.countries_casualty = 0 }	# dummy
}

casualty_sort_list_countries = {
	clear_array = global.countries_casualty
	
	every_country = {
		if = {
			limit = {
				NOT = { is_in_array = { global.countries_casualty = THIS.id } }
			}
			add_to_array = { global.countries_casualty = THIS.id }
		}
	}	

	casualty_sort_add_dummy = yes
}

casualty_sort_total = {
	casualty_sort_list_countries = yes
	casualty_sort_remove_dummy = yes
	
	clr_country_flag = casualty_sort_civ_descending
	clr_country_flag = casualty_sort_mil_descending
	clr_country_flag = casualty_sort_total_ascending
	clr_country_flag = casualty_sort_civ_ascending
	clr_country_flag = casualty_sort_mil_ascending
	
	if = {
		limit = {
			has_country_flag = casualty_sort_total_descending
		}
		clr_country_flag = casualty_sort_total_descending
		set_country_flag = casualty_sort_total_ascending
	}
	else = {
		set_country_flag = casualty_sort_total_descending
	}
	
	set_temp_variable = { len = global.countries_casualty^num }
	subtract_from_temp_variable = { len = 1 }
	##log = "Sort: Indexing Length is [?len]"
	set_temp_variable = { sorted = 0 }
	##log = "Sort: Is sorted - [?sorted]"
	
	while_loop_effect = {
		limit = { 
			NOT = { check_variable = { sorted = 1 } }
		}
		
		# Assume the array is sorted
		set_temp_variable = { sorted = 1 }
		##log = "[?sorted] While started"
		
		if = {
			limit = {
				has_country_flag = casualty_sort_total_descending
			}
			for_loop_effect = {
				start = 0
				end = len
				value = v
				
				set_temp_variable = { w = v }
				add_to_temp_variable = { w = 1 }
				
				if = {
					limit = {
						var:global.countries_casualty^v = {
							set_temp_variable = { global.temp_a = total_casualties_k }
						}
						var:global.countries_casualty^w = {
							set_temp_variable = { global.temp_b = total_casualties_k }
						}
						check_variable = { global.temp_a < global.temp_b }
					}
					set_temp_variable = { sorted = 0 }
					
					##log = "[?global.countries_casualty^v.GetTag] swapped with [?global.countries_casualty^w.GetTag]"
					
					set_temp_variable = { global.sort_a = global.countries_casualty^v }
					set_variable = { global.countries_casualty^v = global.countries_casualty^w }
					set_variable = { global.countries_casualty^w = global.sort_a }
				}
			}
		}
		else = {
			for_loop_effect = {
				start = 0
				end = len
				value = v
				
				set_temp_variable = { w = v }
				add_to_temp_variable = { w = 1 }
				
				if = {
					limit = {
						var:global.countries_casualty^v = {
							set_temp_variable = { global.temp_a = total_casualties_k }
						}
						var:global.countries_casualty^w = {
							set_temp_variable = { global.temp_b = total_casualties_k }
						}
						check_variable = { global.temp_a > global.temp_b }
					}
					set_temp_variable = { sorted = 0 }
					
					##log = "[?global.countries_casualty^v.GetTag] swapped with [?global.countries_casualty^w.GetTag]"
					
					set_temp_variable = { global.sort_a = global.countries_casualty^v }
					set_variable = { global.countries_casualty^v = global.countries_casualty^w }
					set_variable = { global.countries_casualty^w = global.sort_a }
				}
			}
		}
	}
	
	casualty_sort_add_dummy = yes
}

casualty_sort_mil = {
	casualty_sort_list_countries = yes
	casualty_sort_remove_dummy = yes
	
	clr_country_flag = casualty_sort_total_descending
	clr_country_flag = casualty_sort_civ_descending
	clr_country_flag = casualty_sort_total_ascending
	clr_country_flag = casualty_sort_civ_ascending
	clr_country_flag = casualty_sort_mil_ascending
	
	if = {
		limit = {
			has_country_flag = casualty_sort_mil_descending
		}
		clr_country_flag = casualty_sort_mil_descending
		set_country_flag = casualty_sort_mil_ascending
	}
	else = {
		set_country_flag = casualty_sort_mil_descending
	}
	
	set_temp_variable = { len = global.countries_casualty^num }
	subtract_from_temp_variable = { len = 1 }
	##log = "Sort: Indexing Length is [?len]"
	set_temp_variable = { sorted = 0 }
	##log = "Sort: Is sorted - [?sorted]"
	
	while_loop_effect = {
		limit = { 
			NOT = { check_variable = { sorted = 1 } }
		}
		
		# Assume the array is sorted
		set_temp_variable = { sorted = 1 }
		##log = "[?sorted] While started"
		
		if = {
			limit = {
				has_country_flag = casualty_sort_mil_descending
			}
			for_loop_effect = {
				start = 0
				end = len
				value = v
				
				set_temp_variable = { w = v }
				add_to_temp_variable = { w = 1 }
				
				if = {
					limit = {
						var:global.countries_casualty^v = {
							set_temp_variable = { global.temp_a = casualties_k }
						}
						var:global.countries_casualty^w = {
							set_temp_variable = { global.temp_b = casualties_k }
						}
						check_variable = { global.temp_a < global.temp_b }
					}
					set_temp_variable = { sorted = 0 }
					
					##log = "[?global.countries_casualty^v.GetTag] swapped with [?global.countries_casualty^w.GetTag]"
					
					set_temp_variable = { global.sort_a = global.countries_casualty^v }
					set_variable = { global.countries_casualty^v = global.countries_casualty^w }
					set_variable = { global.countries_casualty^w = global.sort_a }
				}
			}
		}
		else = {
			for_loop_effect = {
				start = 0
				end = len
				value = v
				
				set_temp_variable = { w = v }
				add_to_temp_variable = { w = 1 }
				
				if = {
					limit = {
						var:global.countries_casualty^v = {
							set_temp_variable = { global.temp_a = casualties_k }
						}
						var:global.countries_casualty^w = {
							set_temp_variable = { global.temp_b = casualties_k }
						}
						check_variable = { global.temp_a > global.temp_b }
					}
					set_temp_variable = { sorted = 0 }
					
					##log = "[?global.countries_casualty^v.GetTag] swapped with [?global.countries_casualty^w.GetTag]"
					
					set_temp_variable = { global.sort_a = global.countries_casualty^v }
					set_variable = { global.countries_casualty^v = global.countries_casualty^w }
					set_variable = { global.countries_casualty^w = global.sort_a }
				}
			}
		}
	}
	
	casualty_sort_add_dummy = yes
}

casualty_sort_civ = {
	casualty_sort_list_countries = yes
	casualty_sort_remove_dummy = yes
	
	clr_country_flag = casualty_sort_total_descending
	clr_country_flag = casualty_sort_mil_descending
	clr_country_flag = casualty_sort_total_ascending
	clr_country_flag = casualty_sort_civ_ascending
	clr_country_flag = casualty_sort_mil_ascending
	
	if = {
		limit = {
			has_country_flag = casualty_sort_civ_descending
		}
		clr_country_flag = casualty_sort_civ_descending
		set_country_flag = casualty_sort_civ_ascending
	}
	else = {
		set_country_flag = casualty_sort_civ_descending
	}
	
	set_temp_variable = { len = global.countries_casualty^num }
	subtract_from_temp_variable = { len = 1 }
	##log = "Sort: Indexing Length is [?len]"
	set_temp_variable = { sorted = 0 }
	##log = "Sort: Is sorted - [?sorted]"
	
	while_loop_effect = {
		limit = { 
			NOT = { check_variable = { sorted = 1 } }
		}
		
		# Assume the array is sorted
		set_temp_variable = { sorted = 1 }
		##log = "[?sorted] While started"
		
		if = {
			limit = {
				has_country_flag = casualty_sort_civ_descending
			}
			for_loop_effect = {
				start = 0
				end = len
				value = v
				
				set_temp_variable = { w = v }
				add_to_temp_variable = { w = 1 }
				
				if = {
					limit = {
						var:global.countries_casualty^v = {
							set_temp_variable = { global.temp_a = civ_casualties_k }
						}
						var:global.countries_casualty^w = {
							set_temp_variable = { global.temp_b = civ_casualties_k }
						}
						check_variable = { global.temp_a < global.temp_b }
					}
					set_temp_variable = { sorted = 0 }
					
					##log = "[?global.countries_casualty^v.GetTag] swapped with [?global.countries_casualty^w.GetTag]"
					
					set_temp_variable = { global.sort_a = global.countries_casualty^v }
					set_variable = { global.countries_casualty^v = global.countries_casualty^w }
					set_variable = { global.countries_casualty^w = global.sort_a }
				}
			}
		}
		else = {
			for_loop_effect = {
				start = 0
				end = len
				value = v
				
				set_temp_variable = { w = v }
				add_to_temp_variable = { w = 1 }
				
				if = {
					limit = {
						var:global.countries_casualty^v = {
							set_temp_variable = { global.temp_a = civ_casualties_k }
						}
						var:global.countries_casualty^w = {
							set_temp_variable = { global.temp_b = civ_casualties_k }
						}
						check_variable = { global.temp_a > global.temp_b }
					}
					set_temp_variable = { sorted = 0 }
					
					##log = "[?global.countries_casualty^v.GetTag] swapped with [?global.countries_casualty^w.GetTag]"
					
					set_temp_variable = { global.sort_a = global.countries_casualty^v }
					set_variable = { global.countries_casualty^v = global.countries_casualty^w }
					set_variable = { global.countries_casualty^w = global.sort_a }
				}
			}
		}
	}
	
	casualty_sort_add_dummy = yes
}
